{% extends "nav.html" %}

{% block title %}{{ photo.title }} by {{ photo.user.name }} | brickr{% endblock %}

{% block script %}
<script src="{{ url_for('static', filename = 'js/add_note.js') }}" type="text/javascript"></script>
{% include "fix_time.html" %}
<script type="text/javascript">
    window.__photoID = {{ photo.id }};
    window.__userID = "{{ g.user.id or 0 }}";
</script>
{% endblock %}

{% block content %}
    <div id="content-main">
        <div id="single-photo">
            <div id="single-photo-actions">
                <ul>
                    <li><a href="" id="photo-fave" {% if g.user and g.user.isFavorited(photo) %}class="isFavorited" onclick="return false;"{% else %}onclick="addFavorite({{ photo.id }});"{% endif %} title="Add to Favorites">Favorite</a></li>
                    <li><a href="" id="photo-share" title="Share photo (NYI)">Share</a></li>
                    <li><a href="" id="photo-download" title="Download photo (NYI)">Download</a></li>
                </ul>
            </div>

            <div id="single-photo-img">
                <img id="the-actual-photo" src="{{ photo.url() }}" alt="{{ photo.title }}" title="{{ photo.title }}">
                <div id="note-eventer">
                    <div id="note-list">
                        {% for note in photo.getNotesInZOrder() %}
                        <div id="{{ note.id }}" class="note-box" data-brickr-userid="{{ note.user_id }}" data-brickr-coords="{{ note.coords() }}">
                            <div class="note-content">
                                <div class="note-text">{{ note.comment }}</div>
                                <textarea class="note-edit-text" rows="5" placeholder="New Note" aria-label="New Note">{{ note.comment }}</textarea>
                                <div class="note-buttons">
                                    <input type="button" class="note-save-button small-button" value = "SAVE" />
                                    <input type="button" class="note-cancel-button small-button" value = "CANCEL" />
                                    <input type="button" class="note-delete-button small-button" value = "DELETE" />
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <!-- This dummy is duplicated when user creates new notes.  Make sure its DOM stays in sync with real note def above -->
                <div id="dummy-note-placeholder" class="note-box" style="display: none">
                    <div class="note-content">
                        <div class="note-text"></div>
                        <textarea class="note-edit-text"></textarea>
                        <div class="note-buttons">
                            <input type="button" class="note-save-button small-button" value="SAVE" />
                            <input type="button" class="note-cancel-button small-button" value="CANCEL" />
                            <input type="button" class="note-delete-button small-button" value="DELETE" />
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="single-photo-info">
                {% if g.user and photo.user.id == g.user.id %}
                    <h2 class="single-photo-title photo-display-info" onclick="editPhotoInfo(true);">{{ photo.title }}</h2>
                    <input class="single-photo-title-edit photo-edit-info" type="text" />
                    <div class="single-photo-desc photo-display-info" onclick="editPhotoInfo(true);">{{ photo.description }}</div>
                    <textarea class="single-photo-desc-edit photo-edit-info"></textarea>
                    <div class="photo-text-buttons photo-edit-info">
                        <input type="button" class="save-button small-button" value="SAVE" onclick="editPhotoInfo(false, {{ photo.id }});"/>
                        <input type="button" class="cancel-button small-button" value="CANCEL" onclick="editPhotoInfo(false, -1);"/>
                    </div>
                {% else %}
                    <h2>{{ photo.title }}</h2>
                    <div>{{ photo.description }}</div>
                {% endif %}
            </div>
        </div>
    </div>

    <div id="content-sidebar">

        <div id="profile" class="sidebar-box">
            <img src="{{ url_for('static', filename = 'img/avatar.jpg') }}" alt="" title="" border="0" width="100" height="100">
            <div id="single-photo-meta">
                <h3>{{ photo.user.name }}</h3>
                <ul>
                    <li>{{ photo.views }} Views</li>
                    <li>Taken on <span class="convert-time">{{ photo.creation_time }},LL</span></li>
                </ul>
            </div>
        </div>

        <div id="quick-photostream" class="sidebar-box">
            <h3>{{ photo.user.name }}'s photosteam <span class="small">({{ photo.user.photos.count()}})</span></h3>
            <div class="slider-stream">
                {% for p in photo.getAdjacentPhotoStream(4) %}
                    {% if p %}
                        <a href="{{ url_for('photos.photo', user_url = p.user.url, photoID = p.id) }}">
                            <img src="{{ p.url_thumb(75) }}" alt="{{ p.title }}" title="{{ p.title }}" border="0" height="55" width="55" />
                        </a>
                    {% else %}
                        <img src="{{ url_for('static', filename = 'img/avatar.jpg') }}" alt="" title="" border="0" height="55" width="55" />
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        {% if photo.groups %}
        <div id="single-groups" class="sidebar-box">
            <h3>Also in</h3>
            <ul>
                {% for group in photo.groups %}
                <li><a href="{{ url_for('groups.group', groupURL = group.url_name) }}">{{ group.name }}</a></li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div id="tags" class="sidebar-box">
            <h3>Tags
            {% if g.user and photo.user.id == g.user.id %}
                <span class="small" id="addTagLink">(<a href="javascript:$('input#tagBox').show();$('span#addTagLink').hide();">add a tag</a>)</span>
            {% endif %}
            </h3>
            <ul id="tagList">
                {% for tag in photo.tags %}
                <li><a href="">{{ tag.description }}</a></li>
                {% endfor %}
            </ul>
            <br /><br />
            <input type="text" id="tagBox" style="display: none" onkeypress="tagKeyPress(this, event, {{ photo.id }});">
        </div>
        
        {% if g.user and photo.user.id == g.user.id %}
            <a href="{{ url_for('photos.delete', photoID = photo.id) }}" onclick="return confirm('Do you really want to delete this photo?');">Delete this Photo</a>
        {% endif %}        
    </div>

    <div id="content-interact">

        {% if photo.favorites and photo.favorites.count() %}
        <div id="photo-favorites">
            <div class="hr"></div>
            <p>
            {% set favDispCount = 4 %}  {# change this number to set how many people are listed in the 'added this photo' text #}
            {% for favorite in photo.favorites.slice(0, favDispCount + 1) %}
                {% if loop.last and loop.index0 >= favDispCount %}
                and {{ photo.favorites.count() - favDispCount }} others
                {% else %}
                    {% if loop.last and loop.index0 > 0 %}and{% endif %}
                    <a href="{{ url_for('photos.stream', user_url = favorite.user.url) }}">{{favorite.user.name}}</a>{% if loop.revindex0 > 0 %},{% endif %}
                {% endif %}
            {% endfor %}
            added this photo to their favorites.</p>
            <div class="hr"></div>
        </div>
        {% endif %}

        {% if photo.comments and photo.comments.count() %}
        <div id="photo-comments">
            <h3>Comments:</h3>
            <ul>
                {% for comment in photo.comments %}
                <li>
                    <div class="comments-avatar">
                        <a href="{{ url_for('photos.stream', user_url = comment.user.url) }}">
                            <img src="{{ url_for('static', filename = 'img/avatar.jpg') }}" alt="" title="" border="0" height="36" width="36">
                        </a>
                    </div>
                    <div class="comments-body">
                        <div class="comments-author">
                            <a href="{{ url_for('photos.stream', user_url = comment.user.url)}}">{{comment.user.name}}</a>
                            <span class="small comments-date"><span class="convert-time">{{ comment.creation_time }},fromNow</span></span>
                        </div>
                        <div class="comment-text">{{ comment.comment | safe }}</div>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        {% if g.user %}
        <div id="photo-add-comment">
            <div class="hr"></div>
            <h3>Add a Comment</h3>
            <form method="POST" action="{{ url_for('photos.addComment') }}" class="form">
                <textarea id="comment" name="comment" rows="6" placeholder="Add a comment" aria-label="Add a comment"></textarea>
                <input type="hidden" value="{{ photo.id }}" id="photoID" name="photoID">
                <input type="submit" value="Submit" class="button">
            </form>
        </div>
       {% endif %}
    </div>
{% endblock %}
